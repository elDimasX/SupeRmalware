/*

	Operação de processos, como obter nome completo e etc

*/

// http://www.codewarrior.cn/ntdoc/wrk/ps/PsReferenceProcessFilePointer.htm
NTSTATUS
PsReferenceProcessFilePointer(
	IN  PEPROCESS Process,
	OUT PVOID* OutFileObject
);

/// <summary>
/// Obtém o nome completo do processo, para que possa detectar os antivírus
/// </summary>
/// <param name="Process"></param>
/// <returns></returns>
PUNICODE_STRING GetFullProcessName(
	_In_ PEPROCESS Process
)
{
	// Tente
	__try {

		PFILE_OBJECT FileObject;
		POBJECT_NAME_INFORMATION FileObjectInfo;

		// Obtenha o ponteiro do processo
		NTSTATUS Status = PsReferenceProcessFilePointer(Process, &FileObject);

		// Falha
		if (!NT_SUCCESS(Status))
		{
			return NULL;
		}

		// Tente obter o local do arquivo
		Status = IoQueryFileDosDeviceName(FileObject, &FileObjectInfo);

		// Falhou
		if (!NT_SUCCESS(Status))
		{
			return NULL;
		}

		// Retorne o nome do arquivo em UNICODE_STRING
		return &(FileObjectInfo->Name);

	}
	__except (EXCEPTION_EXECUTE_HANDLER)
	{
	}

	// Não conseguiu retornar nada
	return NULL;
}
